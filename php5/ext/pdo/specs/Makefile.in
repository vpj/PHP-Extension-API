# vim:ts=2:sw=2:noet:
XSLTPROC=@XSLTPROC@ --nonet
HERE=@HERE@
TAR=@TAR@
SED=@SED@
BASH=@BASH@
AWK=@AWK@
BUILDDIR=@srcdir@/build
GMAKE=@GMAKE@
BITS=$(BUILDDIR)/bits

.PHONY: book.xml.in

XML_CATALOG_FILES=$(BUILDDIR)/docbook-xsl/catalog.xml $(BUILDDIR)/docbook-xml/catalog.xml
SGML_CATALOG_FILES=$(XML_CATALOG_FILES)
export XML_CATALOG_FILES FOP SGML_CATALOG_FILES SED TAR

all: docbook-env book.xml html

docbook-env: $(BUILDDIR)/docbook-xsl $(BUILDDIR)/docbook-xml $(BUILDDIR)/bits

$(BUILDDIR)/bits:
	mkdir $(BUILDDIR)/bits

# need to touch the dir because the timestamp in the tarball
# is older than that of the tarball :)
build/docbook-xsl: $(BUILDDIR)/docbook-xsl-1.69.1.tgz
	cd $(BUILDDIR) && $(TAR) xzf docbook-xsl-1.69.1.tgz && touch docbook-xsl

build/docbook-xml: $(BUILDDIR)/docbook-xml-4.4.tgz
	cd $(BUILDDIR) && $(TAR) xzf docbook-xml-4.4.tgz && touch docbook-xml

clean:
	-rm *.fo html/*.html book.xml

# Build the docs in HTML format
html: html/index.html html/big.html

html/big.html: book.xml
	$(XSLTPROC) --xinclude --output html/big.html $(BUILDDIR)/html-big.xsl book.xml

html/index.html: book.xml
	$(XSLTPROC) --xinclude --output html/index.html $(BUILDDIR)/html.xsl book.xml

check: book.xml
	xmllint --xinclude --nonet --noout --postvalid book.xml

book.xml: $(BUILDDIR)/docbook-xsl $(BUILDDIR)/docbook-xml book.xml.in
	sed -e "s/@PUBDATE@/`date`/g;" < book.xml.in > $(BITS)/book.xml
	$(XSLTPROC) --output book.xml $(BUILDDIR)/docbook-xsl/profiling/profile.xsl $(BITS)/book.xml

